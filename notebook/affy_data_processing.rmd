---
title: Processing Affymetrix Microarrays
output: 
    html_document:
        code_folding: show
params:
    test_value: 10
---

### Import Packages
```{r}
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")

#  BiocManager::install("oligo")
#package for reading CEL files, will add more packages for further steps
```
### Import Raw Data
```{r}
csv_file <- read.table(file = r"(C:\Users\linde\rmarkdown\affy_processing\data_runsheets\GLDS_6_runsheet.csv)", 
                       sep=",",
                       header = TRUE,
                       check.names = FALSE
                       )
array_data_files <- csv_file["Path to Raw Data File"] #column name of paths

raw_data <- oligo::read.celfiles(array_data_files) #ExpressionFeatureSet Class
```

### Verify Data
```{r}
print("Verify Data step")
```

### Quality Analysis 
### QA: Visualization
```{r}
density_plot <- hist(raw_data, transfo=log2, which=c("pm", "mm", "bg", "both", "all"),
                    nsample=10000, target = "core", main = "Density Plot")
## TODO: Add sample legend   
#legend(15, 0.35, legend=c(colnames(raw_table)), lty=1:2, cex = 1)
# legend() is not compatable
```
# transfo : used to scale the data
# which : defines specific probe types
# nsample : sample size used to produce plot
# target : specifies group of meta-probeset
# main : main title 
```{r}
pseudoimage <- image(raw_data, transfo=log2)
```
```{r}
MA_plot <- MAplot(raw_data)
```
### QA: Statistics
```{r}
# BiocManager::install("AnnotationDbi")
# BiocManager::install("Biobase")
```
### IQRray
```{r}
# The IQRray statistic is obtained by ranking all the probe intensities from
# a given array and by computing the average rank for each probe set. The
# interquartile range (IQR) of the probe sets average ranks serves then as
# quality score. 
#Example of a low score: 122783.6
#   high score: 226124.6
library(methods)
library(AnnotationDbi)
library(Biobase)

	#data - Affybatch object obtained after reading in celfiles into R with function ReadAffy from package affy
	
	#obtaining intensity values for perfect match (pm) probes
pm_data<-pm(raw_data)
	
	#ranking probe intensities for every array 
rank_data<-apply(pm_data,2,rank)
	
	#obtaining names of probeset for every probe
probeNames<-probeNames(raw_data)
	
	#function computing IQR of mean probe ranks in probesets 
get_IQR<-function(rank_data,probeNames){round(IQR(sapply(split(rank_data,probeNames),mean)),digits=2)}
	
	#computing arIQR score
IQRray_score<-apply(rank_data,2,get_IQR,probeNames=probeNames)	

```


### Normalize Data
```{r}
just_norm <- normalize(raw_data)
just_norm_table <- exprs(just_norm) #maybe probe level?
# normalize will will return a matrix with same dimensions as the input matrix. 
#   If applied to a FeatureSet object, the PM matrix will be used as input
# could apply same methods of normalization as rma() to get probe level
```
```{r}
justNorm <- preprocessCore::normalize.quantiles(raw_data, copy=TRUE,weights=NULL,
                remove.extreme=c("variance","mean","both","none"),
                n.remove=1,use.median=FALSE,use.log2=FALSE)
```
```{r}
# RMA is most commonly used method for preprocessing normalization of Affymetrix microarray data. There
# are three steps in the RMA algorithm: Convolution Background Correction, Quantile Normalization, and
# Summarization using Median Polish.
normRMA <- rma(raw_data)
norm_gene_table <- exprs(normRMA)  #gene level
#normalized_data <- rma(raw_data, background=TRUE, normalize=TRUE, subset=NULL)
```
```{r}
raw_table <- exprs(raw_data)
```
```{r}
MAplot_norm <- MAplot(just_norm)
```

```{r}
densityPlot_norm <- hist(just_norm)
```
### Verify Normalization
```{r}
print("Verify Normalization step")
```
### DGE Analysis
```{r}
print("DGE Analysis step")
```
### Gene Annotations
```{r}
print("Gene Annotations step")
```
```{r}
quantileNormalization <- preprocessCore::normalize.quantiles(raw_table, keep.names=TRUE)
```